<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="for technology">
<meta name="keywords" content="keep calm , and deep learning">
<meta property="og:type" content="website">
<meta property="og:title" content="Icewine">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Icewine">
<meta property="og:description" content="for technology">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Icewine">
<meta name="twitter:description" content="for technology">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title>Icewine</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Icewine</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/08/27/hysteria/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="IcewineChen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/Rinne.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Icewine">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/08/27/hysteria/" itemprop="url">Hysteria</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-27T22:17:42+08:00">
                2018-08-27
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/杂谈/" itemprop="url" rel="index">
                    <span itemprop="name">杂谈</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>不得不说社会矛盾现在可能逐渐都折射到学校里了，象牙塔里弥散着一种好闻的腐朽气息，实在让人觉得哭笑不得。</p>
<p>上研一年，唯一感受到的情绪就是极端的荒诞。从各种角度来说，这一年基本可以称的上是魔幻现实主义的一年了。很多闹剧目前看起来跟喜剧别无二致。暴民的狂欢和暴动一直在推进，大概以下一句话可以概括总结社会百态：</p>
<blockquote>
<p>“每个人都是水明星，都是嗨明星” — 抽象圣经</p>
</blockquote>
<p><img src="https://timgsa.baidu.com/timg?image&amp;quality=80&amp;size=b9999_10000&amp;sec=1535390574380&amp;di=901de46ab16b2e9610a712c2752c0b0f&amp;imgtype=0&amp;src=http%3A%2F%2Fn.sinaimg.cn%2Fsinacn%2Fw429h513%2F20171213%2F1d5a-fypsqiz5453383.jpg" alt="avatar"></p>
<p>我同样也暴动了一年。这一年感觉天天没啥心情也没啥目标，机械性的重复劳动，重复码，看看文章，学学数学，然后回屋开始焦虑。再这样继续下去，我都觉得有必要画一条失眠曲线来表现我的悲惨。睡着慢还不够，每每隔个几天我都会有在睡梦中坠落的奇妙体验，这种感觉让我欲罢不能，莫名奇妙的愉悦，唯一的缺点就是半夜容易醒。</p>
<p>这到不怎么奇怪，毕竟焦虑我觉得在天朝研究生中实在是太普遍了，见怪不怪。每天白天疯狂看paper刷代码搭framework或是干一干水水的工程，晚上懈怠下来大概率会焦虑一下嘛，也正常。夹在导师和毕业要求中间，每个人不是失去了尊严，就是失去了自我：我可以循规蹈矩，但是必须放弃尊严；我也可以装死装蠢不听话，但是这样就丧失自我。这种里外不是自己的感觉非常糟糕，伴随着临近毕业的社会压力，往往越来越糟，陷入一个我好想毕业啊 -&gt; 房价好贵，我买不起 -&gt; 还是接着上学吧 -&gt; 上学上够了这种死循环中。而且现在工作岗位竞争也确实竞争激烈，不得不感叹一句晚生了几年。毕竟社会真相大概就是资本决定一切，资本世界的法则我看起来只有一条：</p>
<blockquote>
<p>优先进场</p>
</blockquote>
<p>这大概是最好赢的办法。很多又蠢又坏的人总在宣传自己无耻的成功学，然而成功的本质就是优先进场。然后无数神经病盯着脑残式的鸡汤一直吮来吮去，直到最后价值观全都带跑偏了，蠢货就能以2的指数倍疯狂增长，然后开始画大饼收割。这种成功最厉害的影响还在于一点，就是让很多不自知的人做上了春秋大梦，开始自诩精英，梦想自己是个时代弄潮儿。这种人可真是太多了，之后这些腌臜构成了社会价值观主流，再以自己无耻至极的价值观强行审判我。我可去你妈的。我没啥追求，只求你自己多蠢多肮脏随意，但是请别拿这个视角看我。然而在大环境下，这种诉求大概是一种奢求。</p>
<p>我最想抱怨的就是这种奇形怪状的价值观。太多人完全信奉利益驱动型的形式准则，但是我着实不喜欢这个思维方式。腐朽的价值观带来太多戾气和势利，没人不喜欢钱，这毕竟是这个世界最有力的价值交换工具，但是整个社会对金钱的渴望达到一种病态程度的时候，带来的负面影响实在是太大了。信誉与公信力的下降，带来的问题绝不是一时质疑，如果您总觉得钻个空子就是别人都傻，那我也确实说不出话来。</p>
<p>只是很可惜，我在荒诞的环境里见了太多典型了。我现在搞不清楚到底是我格格不入，还是我高风亮节了。压迫并不能换来反抗，包容也不能带来收益。而更魔幻的其实还是所谓同龄人的相处，满嘴闭嘴都是百元人民币的年代，总让我产生一种我活在一堆资本家中间的错觉。我其实对自诩社会精英的一类人一向反感，占着我们无产阶级的坑带入资本家立场，反过来想当p民头上三座大山。这到底算是抽象还是现实？我觉得这大概是太现实了一点。然而很多人对现实主义的理解也有偏差。我信奉节能一点的现实主义，那就是比普通人过的好一点算是成功。现实从来不是空想或是势利，好歹也是要先看清现实再谈现实主义的吧？</p>
<blockquote>
<p>我大概听了各种过于现实的例子。比如说女生说男生没房我要找个北京有房的之流这种故事。我一直觉得从小到大听过最搞笑的说法就是婊子总说女生比男生更成熟。说这种话不觉得搞笑么？靠性别换来的利益变现什么时候变成成熟的标志了？容我先大笑三声。鸡比鸭多说明鸡比鸭高贵？笑掉大牙。</p>
</blockquote>
<p>没人跟过的更好过不去。底线这个东西在现在确实被模糊的很厉害，也搞不清楚是人类文明进化的一种形式还是浪漫主义倒退的具体表现。</p>
<p>只不过问题是夹在社会奇妙价值观和周围环境中间的一批人，日子着实也不太好过。正反从来都是相对的，对错也一样，都是一种微妙的平衡，只不过目前我的正确处在平衡里错误的一方。</p>
<p>“请品味我的声嘶力竭”。</p>
<p>这大概就是我唯一能说的。这样的生活着实没花光我所有力气，但是大概磨掉了我本来就不多的棱角。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/08/27/吐槽预报/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="IcewineChen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/Rinne.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Icewine">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/08/27/吐槽预报/" itemprop="url">吐槽预报</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-27T00:34:14+08:00">
                2018-08-27
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/杂谈/" itemprop="url" rel="index">
                    <span itemprop="name">杂谈</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>这半年或者一年都很烦，每天都想吐槽。明天干完正事花时间写一篇完整的zz玩意吐槽，真是受不了了。</p>
<p>在网上咱就是个大喷子。Re不Real？明天咱喷半年份的。</p>
<p>记得明天把最近做的系统demo代码先放一下。老子不干图像了！深度学尼玛呢？剩下两年多看看文章复现复现人家论文，我发现自己真没啥研究天赋，还好当时没脑抽去直博。做完这票实验缓缓劲。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/08/19/分享/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="IcewineChen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/Rinne.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Icewine">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/08/19/分享/" itemprop="url">分享</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-19T10:28:55+08:00">
                2018-08-19
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/deep-learning/" itemprop="url" rel="index">
                    <span itemprop="name">deep learning</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>分享一版整理的一些姿态估计心得的repo：<a href="https://github.com/IcewineChen/Pose-estimation_tutorials" target="_blank" rel="noopener">https://github.com/IcewineChen/Pose-estimation_tutorials</a>, 估计之后blog不会继续单开相关的东西了……</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/07/29/gluon/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="IcewineChen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/Rinne.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Icewine">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/29/gluon/" itemprop="url">谈谈gluon和其他我用过的框架</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-07-29T22:35:16+08:00">
                2018-07-29
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/mxnet/" itemprop="url" rel="index">
                    <span itemprop="name">mxnet</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="关于gluon"><a href="#关于gluon" class="headerlink" title="关于gluon"></a>关于gluon</h2><p>前几天跟小伙伴们讨论到了几个问题，突然讨论这个事情：比如说我的数据load进来之后，想把不同的batch并行，这样该怎么弄？</p>
<p>我很喜欢pytorch，但是我大部分时间对pytorch的并行调用dataparallel时的实际操作是把数据一个batch拆分，然后并行到设备上，很明显不符合需求，要是改动还得对底层动刀。然后突然想到嗯，好像除了这个问题，有些时候去符号式这种东西，还真不太适合快速复现或者验证想法。目前大部分时间复现我确实都优先考虑mxnet做。如果不太需要自定义层，基本才会考虑pytorch。</p>
<p>然后呢……就是安利一发mxnet了。顺带也相当于总结下我对这些框架的使用体验。最早在16年的时候，我猜大家肯定都在耍……caffe。那时候出于我写c++写习惯了的，一度出现了c++是世界上最好的语言的错觉……事实上caffe确实定制度好，自由度高，python接口也问题不大，但是确实需要自定义的太多，编译各种问题吐血，而且出于语言习惯，我更乐意从头写个layer，backward慢慢磨，然而这确实相当浪费时间。而且到后来越来越多的文章都在用tensorflow，出于代码的编写和调试时间成本，还是基本放弃了caffe，除非有时候看一些早期的文章，放出的代码基于caffe还会看一看，其他时候基本不考虑caffe了。caffe2出了以后，detectron似乎也没能完全拯救他，我是编译了一份扔一边了。不过当年在公司实习的时候，大家确实也都在用caffe，我的结论就是是出于部署和性能考量，caffe比较适合。然而mxnet在分布式和部署上我觉得不比caffe差，事实也确实是后续业务也开始转向mxnet。总体而言caffe在科研上开始没用tensorflow或是pytorch那么闪光了。</p>
<p>之后tensorflow。没什么可多说的，基本上你肯定得会。放tensorflow代码的文章多如牛毛，文章多，社区好，早期时候带自动微分这种牛逼功能，背景牛逼，而且符号式编程其实更符合我的思维方式（也可能有人对符号式编程写model不习惯，这个只是个人意见）。然后绝大部分时间我research绝不会写tensorflow的代码。为啥……那个调试真的痛苦的要死，我对tensorflow的更新最终停在了estimator出来的那个版本。虽然后期的eager Execution机制引入动态图，但是本质上依然只是一个功能，整个框架依然是基于静态图开发的。tensorflow对于实现你表达的思路是个非常非常优秀的框架，然而确实会给你中间的一些验证带来很多不必要的麻烦，而且相对比较笨重。对于科研实验来说，很多东西是相当冗余的，对于要求快速实验验证想法的research来说这个问题还是比较致命的。</p>
<p>接下来才是比较重要的比较。我觉得对于大部分来说大概还是偏好pytorch和mxnet一点（其实并没mxnet什么毛关系）。支持动态图，当时刚转到pytorch上的我觉得这简直是最棒的机制了。动态图在调试上优势太大，中间变量查看十分十分方便，对于快速验证模型的一些问题提，比如说中间shape，dtype以及各种问题供了巨大便利，不需要静态图的各种包装以及session去跑。在同样采用动态图的基础上，mxnet和pytorch的核心区别，我觉得大概就在符号编程上了。pytorch继承了torch当年的优良意志：我们绝对不用符号式编程……符号式编程简单来说就是把变量就定义成一个符号，之后把数据扔进来的时候再通过name告诉他哪喂什么就好，相对来说很适合直接扔一个symbol在这，最后再考虑数据的问题就好，可以把模型定义单独作为一件事情。而pytorch数据流向直接定义调用就可以，最后需要求导记得用variable封装好即可。</p>
<p>然而gluon出来以后，我觉得mxnet确实兼顾了各家之长。gluon里两点让我觉得特别优秀。第一点就是不得不提的混合编程，这点看下面代码就知道：<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Hourglass</span>(<span class="title">gluon</span>.<span class="title">nn</span>.<span class="title">HybridBlock</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(<span class="keyword">self</span>,n,nModules,nFeats)</span></span><span class="symbol">:</span></span><br><span class="line">        <span class="keyword">super</span>(Hourglass,<span class="keyword">self</span>).__init_<span class="number">_</span>()</span><br><span class="line">        <span class="keyword">self</span>.n = n</span><br><span class="line">        <span class="keyword">self</span>.nModules = nModules</span><br><span class="line">        <span class="keyword">self</span>.nFeats = nFeats</span><br><span class="line"></span><br><span class="line">        <span class="keyword">self</span>.up1<span class="number">_</span> = gluon.nn.HybridSequential()</span><br><span class="line">        <span class="keyword">self</span>.low1<span class="number">_</span> = gluon.nn.HybridSequential()</span><br><span class="line">        <span class="keyword">self</span>.low2<span class="number">_</span> = gluon.nn.HybridSequential()</span><br><span class="line">        <span class="keyword">self</span>.low3<span class="number">_</span> = gluon.nn.HybridSequential()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="keyword">self</span>.nModules)<span class="symbol">:</span></span><br><span class="line">            <span class="keyword">self</span>.up1<span class="number">_</span>.add(Residual(in_channels=<span class="keyword">self</span>.nFeats,out_channels=<span class="keyword">self</span>.nFeats))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">self</span>.low1 = gluon.nn.MaxPool2D(pool_size=(<span class="number">2</span>,<span class="number">2</span>),strides=(<span class="number">2</span>,<span class="number">2</span>))</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="keyword">self</span>.nModules)<span class="symbol">:</span></span><br><span class="line">            <span class="keyword">self</span>.low1<span class="number">_</span>.add(Residual(in_channels=<span class="keyword">self</span>.nFeats,out_channels=<span class="keyword">self</span>.nFeats))</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.n &gt; <span class="number">1</span><span class="symbol">:</span></span><br><span class="line">            <span class="keyword">self</span>.low2 = Hourglass(n=n-<span class="number">1</span>,nModules=<span class="keyword">self</span>.nModules,nFeats = <span class="keyword">self</span>.nFeats)</span><br><span class="line">        <span class="symbol">else:</span></span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="keyword">self</span>.nModules)<span class="symbol">:</span></span><br><span class="line">                <span class="keyword">self</span>.low2<span class="number">_</span>.add(Residual(in_channels=nFeats,out_channels=nFeats))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="keyword">self</span>.nModules)<span class="symbol">:</span></span><br><span class="line">            <span class="keyword">self</span>.low3<span class="number">_</span>.add(Residual(in_channels=<span class="keyword">self</span>.nFeats,out_channels=nFeats))</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">self</span>.up2 = gluon.nn.Conv2DTranspose(channels=<span class="keyword">self</span>.nFeats,kernel_size=(<span class="number">2</span>,<span class="number">2</span>),strides=(<span class="number">2</span>,<span class="number">2</span>))</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">hybrid_forward</span><span class="params">(<span class="keyword">self</span>,F,x)</span></span><span class="symbol">:</span></span><br><span class="line">        up1 = x</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="keyword">self</span>.nModules)<span class="symbol">:</span></span><br><span class="line">            up1 = <span class="keyword">self</span>.up1<span class="number">_</span>[i](up1)</span><br><span class="line">        </span><br><span class="line">        low1 = <span class="keyword">self</span>.low1(x)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="keyword">self</span>.nModules)<span class="symbol">:</span></span><br><span class="line">            low1 = <span class="keyword">self</span>.low1<span class="number">_</span>[i](low1)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.n &gt; <span class="number">1</span><span class="symbol">:</span></span><br><span class="line">            low2 = <span class="keyword">self</span>.low2(low1)</span><br><span class="line">        <span class="symbol">else:</span></span><br><span class="line">            low2 = low1</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="keyword">self</span>.nModules)<span class="symbol">:</span></span><br><span class="line">                low2 = <span class="keyword">self</span>.low2<span class="number">_</span>[i](low2)</span><br><span class="line">        </span><br><span class="line">        low3 = low2</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="keyword">self</span>.nModules)<span class="symbol">:</span></span><br><span class="line">            low3 = <span class="keyword">self</span>.low3<span class="number">_</span>[i](low3)</span><br><span class="line">        <span class="comment"># gluon的nn里没有upsample，混合直接调用ndarray的sample</span></span><br><span class="line">        <span class="comment"># up2 = F.UpSampling(low3,sample_type='bilinear',scale=2)</span></span><br><span class="line">        up2 = <span class="keyword">self</span>.up2(low3)</span><br><span class="line">        <span class="keyword">return</span> up1 + up2</span><br></pre></td></tr></table></figure></p>
<p>这是我定义的一个Hourglass结构，只需要你的net或者模块继承hybridblock，forward时候就需要实现一个hybrid_forward(self,F,x)。这个F是区别于非混合式forward的量，调用时候F.function就会自动找你的function从什么里调用，是从符号式还是正常数值计算的ndarray的包里去找。这个功能真的相当人性，一部分ndarray中实现的函数，在symbol包内或是gluon.nn包内是没有的，这样使得mxnet的可用性和使用体验更好，用户大概只需要关注结构定义就可以。当然逻辑比较简单的网络可以直接Sequential add即可。</p>
<p>二是几乎没什么学习成本。这个结构看着熟不熟悉？基本就和pytorch里的结构定义是一样的。有大量的人都在主用pytorch，这样的风格从pytorch迁移代码十分方便。比起mxnet symbol相对更繁琐的定义，这种class内部定义层，再在forward连接的方式大家确实写起来十分习惯，而且也比较符合我脑子里想像的dl定义范式和思维习惯。mxnet目前唯一的问题大概api更新太快，之前每一版更新变动都不小，还处在高速发展，其实也就是不太稳定的阶段，但是bug也已经减少了很多，可用性高而且复现好用，个人觉得框架选择的话，pytorch最轻松上手，mxnet大概是使用起来感觉最好的。如果硬要选框架自己写代码，主役pytorch或是mxnet都是好选择，然而考虑到科研中的泛用度，mxnet确实略逊pytorch一筹，mxnet代码的文章不是很多。但是就个人喜好而言，mxnet在gluon引入以后可能更好一点。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/07/16/pytorch-hg-3d代码分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="IcewineChen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/Rinne.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Icewine">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/16/pytorch-hg-3d代码分析/" itemprop="url">pytorch-hg-3d代码分析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-07-16T22:02:25+08:00">
                2018-07-16
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>上次组会分享了CVPR2018的3d pose估计文章 3D Human Pose Estimation in the Wild by Adversarial Learning,文章中提到一种用GAN的方式生成3D in the wild估计的方法。最近准备复现，顺带在这里先分析一下结构中Generator，顺带分析一下代码</p>
<p>生成器的结构参见Towards 3D Human Pose Estimation in the Wild: a Weakly-supervised Approach，感谢作者，该结构以stacked hourglass为base network做一个2d keypoint估计，然后扔进3d regression得到最后的结果。数据集选用了有3d ground truth和没有ground truth的in the wild 2d集拼合，整体结构上在2d估计中抽出了中间层信息送入回归器，迁移了in the wild的信息。</p>
<h2 id="pytorch网络代码分析"><a href="#pytorch网络代码分析" class="headerlink" title="pytorch网络代码分析"></a>pytorch网络代码分析</h2><p>先贴一段核心网络结构的代码：<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HourglassNet3D</span>(<span class="title">nn</span>.<span class="title">Module</span>):</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(<span class="keyword">self</span>, nStack, nModules, nFeats, nRegModules)</span></span><span class="symbol">:</span></span><br><span class="line">    <span class="keyword">super</span>(HourglassNet3D, <span class="keyword">self</span>).__init_<span class="number">_</span>()</span><br><span class="line">    <span class="keyword">self</span>.nStack = nStack</span><br><span class="line">    <span class="keyword">self</span>.nModules = nModules</span><br><span class="line">    <span class="keyword">self</span>.nFeats = nFeats</span><br><span class="line">    <span class="keyword">self</span>.nRegModules = nRegModules</span><br><span class="line">    <span class="keyword">self</span>.conv1<span class="number">_</span> = nn.Conv2d(<span class="number">3</span>, <span class="number">64</span>, bias = True, kernel_size = <span class="number">7</span>, stride = <span class="number">2</span>, padding = <span class="number">3</span>)</span><br><span class="line">    <span class="keyword">self</span>.bn1 = nn.BatchNorm2d(<span class="number">64</span>)</span><br><span class="line">    <span class="keyword">self</span>.relu = nn.ReLU(inplace = True)</span><br><span class="line">    <span class="keyword">self</span>.r1 = Residual(<span class="number">64</span>, int(<span class="number">128</span>))</span><br><span class="line">    <span class="keyword">self</span>.maxpool = nn.MaxPool2d(kernel_size = <span class="number">2</span>, stride = <span class="number">2</span>)</span><br><span class="line">    <span class="keyword">self</span>.r4 = Residual(<span class="number">128</span>, <span class="number">128</span>)</span><br><span class="line">    <span class="keyword">self</span>.r5 = Residual(<span class="number">128</span>, <span class="keyword">self</span>.nFeats)</span><br><span class="line">    </span><br><span class="line">    _hourglass, _Residual, _lin<span class="number">_</span>, _tmpOut, _ll<span class="number">_</span>, _tmpOut<span class="number">_</span>, _reg<span class="number">_</span> = [], [], [], [], [], [], []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="keyword">self</span>.nStack)<span class="symbol">:</span></span><br><span class="line">      <span class="comment"># n阶的hourglass</span></span><br><span class="line">      _hourglass.append(Hourglass(<span class="number">4</span>, <span class="keyword">self</span>.nModules, <span class="keyword">self</span>.nFeats))</span><br><span class="line">      <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="keyword">self</span>.nModules)<span class="symbol">:</span></span><br><span class="line">      <span class="comment"># 连接stacks间的基本残差单元</span></span><br><span class="line">        _Residual.append(Residual(<span class="keyword">self</span>.nFeats, <span class="keyword">self</span>.nFeats))</span><br><span class="line">      lin = nn.Sequential(nn.Conv2d(<span class="keyword">self</span>.nFeats, <span class="keyword">self</span>.nFeats, bias = True, kernel_size = <span class="number">1</span>, stride = <span class="number">1</span>), </span><br><span class="line">                          nn.BatchNorm2d(<span class="keyword">self</span>.nFeats), <span class="keyword">self</span>.relu)</span><br><span class="line">      _lin<span class="number">_</span>.append(lin)</span><br><span class="line">      _tmpOut.append(nn.Conv2d(<span class="keyword">self</span>.nFeats, ref.nJoints, bias = True, kernel_size = <span class="number">1</span>, stride = <span class="number">1</span>))</span><br><span class="line">      _ll<span class="number">_</span>.append(nn.Conv2d(<span class="keyword">self</span>.nFeats, <span class="keyword">self</span>.nFeats, bias = True, kernel_size = <span class="number">1</span>, stride = <span class="number">1</span>))</span><br><span class="line">      _tmpOut<span class="number">_</span>.append(nn.Conv2d(ref.nJoints, <span class="keyword">self</span>.nFeats, bias = True, kernel_size = <span class="number">1</span>, stride = <span class="number">1</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">4</span>)<span class="symbol">:</span></span><br><span class="line">      <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="keyword">self</span>.nRegModules)<span class="symbol">:</span></span><br><span class="line">        _reg<span class="number">_</span>.append(Residual(<span class="keyword">self</span>.nFeats, <span class="keyword">self</span>.nFeats))</span><br><span class="line">    <span class="comment"># append部分对应stackhourglass中的沙漏型结构，将其中用的residual模块和n个Stack整理进sequential的形式方便之后再循环里调用</span></span><br><span class="line">    <span class="comment"># modulelist的取法其实基本跟list一样，封装在modulelist里会检测到每一个的hook，直接包装在list里，每一个单元内部的参数会初始不到</span></span><br><span class="line">    <span class="keyword">self</span>.hourglass = nn.ModuleList(_hourglass)</span><br><span class="line">    <span class="keyword">self</span>.Residual = nn.ModuleList(_Residual)</span><br><span class="line">    <span class="keyword">self</span>.lin<span class="number">_</span> = nn.ModuleList(_lin<span class="number">_</span>)</span><br><span class="line">    <span class="keyword">self</span>.tmpOut = nn.ModuleList(_tmpOut)</span><br><span class="line">    <span class="keyword">self</span>.ll<span class="number">_</span> = nn.ModuleList(_ll<span class="number">_</span>)</span><br><span class="line">    <span class="keyword">self</span>.tmpOut<span class="number">_</span> = nn.ModuleList(_tmpOut<span class="number">_</span>)</span><br><span class="line">    <span class="keyword">self</span>.reg<span class="number">_</span> = nn.ModuleList(_reg<span class="number">_</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">self</span>.reg = nn.Linear(<span class="number">4</span> * <span class="number">4</span> * <span class="keyword">self</span>.nFeats, ref.nJoints)</span><br><span class="line">    </span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">forward</span><span class="params">(<span class="keyword">self</span>, x)</span></span><span class="symbol">:</span></span><br><span class="line">    <span class="comment"># 将定义了的层按顺序传递，构建整个网络的forward顺序</span></span><br><span class="line">    x = <span class="keyword">self</span>.conv1<span class="number">_</span>(x)</span><br><span class="line">    x = <span class="keyword">self</span>.bn1(x)</span><br><span class="line">    x = <span class="keyword">self</span>.relu(x)</span><br><span class="line">    x = <span class="keyword">self</span>.r1(x)</span><br><span class="line">    x = <span class="keyword">self</span>.maxpool(x)</span><br><span class="line">    x = <span class="keyword">self</span>.r4(x)</span><br><span class="line">    x = <span class="keyword">self</span>.r5(x)</span><br><span class="line">    </span><br><span class="line">    out = []</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="keyword">self</span>.nStack)<span class="symbol">:</span></span><br><span class="line">      hg = <span class="keyword">self</span>.hourglass[i](x)</span><br><span class="line">      ll = hg</span><br><span class="line">      <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="keyword">self</span>.nModules)<span class="symbol">:</span></span><br><span class="line">        ll = <span class="keyword">self</span>.Residual[i * <span class="keyword">self</span>.nModules + j](ll)</span><br><span class="line">      ll = <span class="keyword">self</span>.lin<span class="number">_</span>[i](ll)</span><br><span class="line">      tmpOut = <span class="keyword">self</span>.tmpOut[i](ll)</span><br><span class="line">      out.append(tmpOut)</span><br><span class="line">      </span><br><span class="line">      ll<span class="number">_</span> = <span class="keyword">self</span>.ll<span class="number">_</span>[i](ll)</span><br><span class="line">      tmpOut<span class="number">_</span> = <span class="keyword">self</span>.tmpOut<span class="number">_</span>[i](tmpOut)</span><br><span class="line">      <span class="comment"># 取多层信息，作为下一个hourglass的输入，也保存信息到送入reg的x里</span></span><br><span class="line">      x = x + ll<span class="number">_</span> + tmpOut<span class="number">_</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">4</span>)<span class="symbol">:</span></span><br><span class="line">      <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="keyword">self</span>.nRegModules)<span class="symbol">:</span></span><br><span class="line">        x = <span class="keyword">self</span>.reg<span class="number">_</span>[i * <span class="keyword">self</span>.nRegModules + j](x)</span><br><span class="line">      x = <span class="keyword">self</span>.maxpool(x)</span><br><span class="line">      </span><br><span class="line">    x = x.view(x.size(<span class="number">0</span>), -<span class="number">1</span>)</span><br><span class="line">    reg = <span class="keyword">self</span>.reg(x)</span><br><span class="line">    out.append(reg)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> out</span><br></pre></td></tr></table></figure></p>
<p>这就是3d stacked hourglass结构的代码。关于一个nn.Module的代码怎么写，其实参照pytorch源码的Module写就可以，由于自动微分这种东西的存在，继承Module时需要只定义init和forward函数即可。在init函数中，我们定义需要的层，需要的结构，然后在forward中，定义层的连接，也就是网络的结构。这段代码描述了生成器的结构，总体来说，nStack就是单个stacked hourglass的阶数，modules是使用级联的模块数，residual是一个残差结构。ll是我们一开始抽出来的stacked的输出层和中间层的和，也就是抽出层再加上输出的结果，之后在输入维度上做整合。reg是3d信息回归器的结构。在forward中，按照stacked hourglass的方法先加了conv+bn+relu+残差+max pooling的结构调整网络输入，之后搭建2d的级联结构，同时把每个stacked结构中的中间一层抽出来,和每个级联的stack一起送去3d regression。具体的代码注释和一些修改我都放在了我fork的repository里，欢迎来看整个注释和代码啊，现在还没彻底完成，还在这个的基础上加入GAN部分的代码（主要是multi-source的鉴别器）去复现GAN-hg-3d。准备在这个结构上调整，看看in the wild的3d pose的效果如何。大概觉得这个方向在工业界落地上可能还有点价值……以前实习的时候组里也有人做过2d的gesture，问题本质上都差不多。理论上行为这一块市场很大，pose的工作还是很有价值的。</p>
<p>pytorch在大部分时间是不需要定义backward的，基本上直接继承nn.Module就可以实现。不过有时候需要我们自定义loss，这时候loss从function里继承，这里其实本质上你也可以直接写在新的Module里，但是你可以尝试一下在Module的backward里面加上一些print，之后从外部调一下试试看。这时候是不会执行的。因为本身Module底层就是要进行backward的操作，每一步操作的时候都会生成一个Function的子类，最后把这些子类的forward和backward连接到一起。所以这些时候你在module内部写一个backward它根本就不会执行，因为实际上真的调用的是基于Function的backward操作。所以如果有大量自定义而pytorch的底层又没有实现的计算，可以直接自定义一个继承自Function的class，然后再用module封装进去。这也是官方文档的做法，在neural style transfer的那篇tutorial里很好的表示了loss的写法，想再自己动手试试看看的话可以去看一这篇文档。根据我的经验你大概只需要记住：绝大部分时候你不需要自己写backward，但是比如你要实现一种新的下降算法或是已经提供的计算不能满足的层定义，那再自己去写。</p>
<p>那么如果自定义一些操作，请遵照一下结构：<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CustomLoss</span>(<span class="title">torch</span>.<span class="title">autograd</span>.<span class="title">Function</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(<span class="keyword">self</span>,*kwargs)</span></span><span class="symbol">:</span></span><br><span class="line">        <span class="keyword">super</span>(CustomLoss,<span class="keyword">self</span>).__init_<span class="number">_</span>()</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span><span class="params">(<span class="keyword">self</span>,*kwargs)</span></span><span class="symbol">:</span></span><br><span class="line">        raise NotImplementedError</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">backward</span><span class="params">(<span class="keyword">self</span>,)</span></span></span><br><span class="line">        raise NotImplementedError</span><br></pre></td></tr></table></figure></p>
<p>按照function继承是要定义backward的，对grad要进行底层实现，基本上只有loss这部分的定义需要费点事。mxnet的定义倒是可以根据符号编程自动推导，符号式编程加自动微分确实很方便，不过sym的调试其实并没有pytorch的动态图来的直观。感觉mxnet在复现上还是更简单快捷粗暴，不过文档不全和有些地方因为更新太快有bug，稍微有点脱了后腿。pytorch这次的更新据说填了不少坑,就我的感受来说，内存不那么容易被多输入Variable的索引跑到炸了，之前的话以Variable对接dataloader在梯度更新后经常要注意取loss[0]，否则直接会加入Variable中的各种参数。据说目前版本解决了这个问题。</p>
<p>数据集接口没什么太多问题的，dataloader只需要注意cv读和dataloader要求的维度顺序，还有定义最后混合的fusion结构中要构建包含2d ground truth和3d ground truth的样本即可。getitem基本不需要做多少改动，只需要按顺序，3d+2d顺序append，之后索引在3d样本数内读3d，大于部分get 2d样本即可。</p>
<h2 id="关于版本更新导致的问题"><a href="#关于版本更新导致的问题" class="headerlink" title="关于版本更新导致的问题"></a>关于版本更新导致的问题</h2><p>其实原repo的作者是给出了pretrain的模型的，但是在Stage2阶段是用不了的……我单点打到这一行，发现load的模型是有问题的，这一行定在upsample层上：</p>
<blockquote>
<p>self.up2 = nn.Upsample(scale_factor = 2)</p>
</blockquote>
<p>事实上upsample需要一个align_corners的参数，在0.4.0之前这个参数应该被直接给了None，导致在0.4.0版本load pretrain的模型后，跑到upsample层的forward时在module的检查时一直报错，会一直报给你检查不到align_corners。再打进内部检验的断点时，发现确实load的模型align_corner是None。如果使用我修改后的pytorch0.4.0兼容的代码train的模型是不存在这个问题的，然而我检查的时候依然没有找到align_corner参数，理论上应该default是False。这可能是底层实现有改动，更底层的部分我就step out没管了。这个大概是版本更新导致的bug，具体有待继续调试验证。如果想看pytorch修改后能用的代码，可以直接跑我fork后的fixed branch，里面已经做了对应的各种修改，在python2.7+ubuntu16.04+pytorch0.4.0下可以正常运行。</p>
<h2 id="后续工作"><a href="#后续工作" class="headerlink" title="后续工作"></a>后续工作</h2><p>之后会打算对文中内容复现。不过目前遇到一个问题是关节点depth map怎么得到。这个问题目前没找到什么合适的代码或是工具，如果有大佬知道的话希望能邮件或是github issue给我……非常感谢</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/07/13/高亮测试/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="IcewineChen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/Rinne.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Icewine">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/13/高亮测试/" itemprop="url">没有任何意义的高亮测试</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-07-13T00:10:05+08:00">
                2018-07-13
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/杂谈/" itemprop="url" rel="index">
                    <span itemprop="name">杂谈</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"highlight"</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="意义不明的测试"><a href="#意义不明的测试" class="headerlink" title="意义不明的测试"></a>意义不明的测试</h1><p>之前想写多写点代码分析和最近跑的实验代码的剖析，结果发现代码高亮不了……现在hexo的代码高亮卡的比较严，首先得先把site下的config里的highlight字段的几项变为true（之前的auto_detect是false），再把主题下的config里的highlight的主题修改成自己想修改的即可，hexo里自带了5种高亮。</p>
<h1 id="下一篇填坑"><a href="#下一篇填坑" class="headerlink" title="下一篇填坑=-="></a>下一篇填坑=-=</h1><p>之后周末填个坑吧……pytorch0.4其实最近跑了一下好多坑都被填完了。周末随便写点mxnet和pytorch的代码分析和总结吧。就酱。想回家睡两觉。不过想先把最近看的番总结一下，顺带给island安利一波……非常超神的游戏，可能这两天给今年一月番做个总结，讲讲游戏，开个游戏块吧……这个博客大概以后会频繁更更，也当发发牢骚了，顺带在漫评路上走一走……多说和网易云跟帖都挂了，所以评论暂时就不开了</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/07/08/human-pose-estimation/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="IcewineChen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/Rinne.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Icewine">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/08/human-pose-estimation/" itemprop="url">human pose estimation</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-07-08T20:40:32+08:00">
                2018-07-08
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/deep-learning/" itemprop="url" rel="index">
                    <span itemprop="name">deep learning</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/deep-learning/paper-reading/" itemprop="url" rel="index">
                    <span itemprop="name">paper reading</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/deep-learning/paper-reading/pose-estimation/" itemprop="url" rel="index">
                    <span itemprop="name">pose estimation</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>从上学期末到现在，在姿态估计方面的工程和论文、实验也算做了不少。现在想着总结一下，理清一下思路，对之后的研究和实验也能提供一点帮助。pose estimation是个很有意思的课题，目前2d的pose已经做得很成熟了，in the wild或是多人任务都已经非常不错了，3d pose目前还有很多潜力可挖。2d pose多用heatmap特征，ground truth多以keypoints的ground truth坐标高斯分布内生成。3d上方法普遍还是以2d的结果+深度信息的回归做框架。不过最近读了一篇CVPR2018的3d pose工作，觉得3d pose在in the wild上还有很大潜力可挖，在这里也会分享一下。</p>
<h1 id="研究概述"><a href="#研究概述" class="headerlink" title="研究概述"></a>研究概述</h1><h2 id="2d-pose-estimation"><a href="#2d-pose-estimation" class="headerlink" title="2d pose estimation"></a>2d pose estimation</h2><p>从CVPR2016到AAAI2018，2D &amp; 3D human pose estimation（姿态估计）浮现了不少好的方法。按时间顺序来说，我大概印象比较深刻的有：</p>
<ul>
<li>Convolution pose machine，出自2016的CVPR。论文地址(<a href="https://www.cv-foundation.org/openaccess/content_cvpr_2016/papers/Wei_Convolutional_Pose_Machines_CVPR_2016_paper.pdf" target="_blank" rel="noopener">https://www.cv-foundation.org/openaccess/content_cvpr_2016/papers/Wei_Convolutional_Pose_Machines_CVPR_2016_paper.pdf</a>) ，CMU的工作，一种2D pose估计的方法，利用多个不同scale的effective Receptive Field对应的heatmap进行姿态估计。我个人觉得这篇工作其实很不错，之前做的项目用到过cpm的model做预测，对于固定摄像角度的单人姿态估计非常不错，不过model嵌入到系统里速度和效果不如下面提到的openpose，而且工作在2018年视角看来也比较老了……不过我觉得CPM工作挺经典的，我最早接触的工作也是这篇。</li>
<li><p>Stacked Hourglass Network，论文地址（<a href="https://arxiv.org/abs/1603.06937" target="_blank" rel="noopener">https://arxiv.org/abs/1603.06937</a>) ，非常经典的工作，很多后续的工作都以stacked hourglass作为backbone或者baseline，许多3d pose的工作也借鉴了这一结构。这篇文章提出的stacked hourglass的方法，用了一种downsample-upsample的encode-decode的结构。stacked hourglass使用了一种residual module的初级模块，采用了卷积路加跳连路，跳连路卷积核保证单元输入输出channel相同。之后以residual module为base结构，逐级降采样后再重新升采样，每一个降采样路会跳出一个跳连路以保留原尺度，再与升采样后同一尺度的输出相加，整个结构图如下所示<br><img src="http://wx1.sinaimg.cn/mw690/005uXRWzly1ft2s2xbgkyj30rm0aomye.jpg" alt=""></p>
</li>
<li><p>鼎鼎大名的openpose库的文章，出自2017的CVPR。Realtime Multi-Person 2D Pose Estimation using Part Affinity Fields，也是来自CMU的工作。这个work工程价值也很高，在github上也开源了openpose库，自带demo里有一个多人场景下的pose estimation demo。这篇文章和工作主要贡献在提供了一种多人场景下的姿态估计方法，不同于许多先做检测再做pose的自上而下方法，这篇文章直接采用了自下而上的思路，将关键点heatmap和人的关节之间的连接策略一起得到。base network采用了一种multi-branch的结构，其中一路用于提keypoint的confidence map，另一个branch用于提PAF，也就是用于关节连接的特征，每一路都有多个stage，最后自然而然地实现了多人场景下的pose estimation。这篇文章的网络结构如下所示<br><img src="http://wx3.sinaimg.cn/mw690/005uXRWzly1ft2saiwrcmj30nd09tac2.jpg" alt=""></p>
</li>
<li><p>pyramid residual network，出自ICCV2017的文章。 文章全名learning feature pyramids for human pose estimation。可以直接去ICCV2017的库里搜。这篇文章好在写的非常详细……怎么说呢，就是读起来非常非常舒服，文章结构很好。其实核心思想就是在stacked hourglass based network的基础上，将residual module替换成了pyramid module，pyramid residual module利用了输入的多个scale，在性能上得到了一定的提升。文章还提到了这种multi-scale的网络初始化的一些trick，并且设计了一个实验来验证residual network中将shortcut一路改成BN+relu+3x3卷积效果更好（虽然我实在想不明白为什么）……不过我觉得这文章的写法和思路非常清晰，所以拿出来想说一下。下面给出prm单元的结构，就是这种利用了输入的多个scale的multi结构，也算是比较巧妙<br><img src="http://wx1.sinaimg.cn/mw690/005uXRWzly1ft2smte6gvj30nw08xwgm.jpg" alt=""></p>
</li>
</ul>
<h2 id="3d-pose-estimation"><a href="#3d-pose-estimation" class="headerlink" title="3d pose estimation"></a>3d pose estimation</h2><p>接下来想提两篇3d pose estimation的工作。也可以说是两篇半……因为有一篇其实是听组内分享时候学习的=-=</p>
<blockquote>
<p>首先简单提下这半篇吧。出自A simple yet effective baseline for 3d human pose estimation。以2d的骨架作为输入，然后回归直接得3d骨架信息。整个结构如下所示。延续了2d+regression的思路。</p>
</blockquote>
<ul>
<li>这周末读了两篇in the wild的3d pose工作。第一篇是Towards 3D Human Pose Estimation in theWild: aWeakly-supervised Approach， ICCV2017的工作。这篇文章利用了一种弱监督的思路，将2d和3d dataset放在一起训练，利用一些先验经验定义了一个2d数据集生成结果的3d 回归loss。该方法的数据集combine了2d和3d集，3d集有3d pose的ground truth，但是3d数据集都是出自lab环境，起不到in the wild的无约束效果。那怎么办？引入2d集做弱监督。整体网络结构还是先用stacked hourglass做2d预测，不同的是这次利用了stacked hourglass中多个层的信息作为3d回归模块的输入，再去进行3d回归，这样在3d回归的模型中，引入的in the wild的2d数据集的弱监督就会将constraint引入了结果，实现了in the wild上的性能提升，我在这理解为一种transfer的trick。这个思路也在后面的基于GAN的工作中作为generator。整体结构如下</li>
</ul>
<p><img src="http://wx2.sinaimg.cn/mw690/005uXRWzly1ft2taka98hj30qx095jtt.jpg" alt=""></p>
<ul>
<li>之后是我这周末读的另一篇工作，跟PRM出自同一个组的工作，3D Human Pose Estimation in the Wild by Adversarial Learning，出自CVPR2018。整体思路是用GAN改善一下上面这篇的work。generator直接选用了上一篇的结构，在discriminator上，用了一种多输入的结构：</li>
</ul>
<p><img src="http://wx2.sinaimg.cn/mw690/005uXRWzly1ft2tey7fwij30fk0bnjsx.jpg" alt=""></p>
<ul>
<li>在其中，geometric descriptor是将ground truth和sample的x,y,z坐标之差和平方直接取pairwise形式的6D向量，2d heatmap和depth map直接就是从2d和3d module得到，这个结构值得借鉴。discriminator将所有3d信息编码后以1为y算一个binary entropy loss，2d sample以0为y去算loss。训练时，先train生成器，再轮流train discriminator和generator即可。</li>
</ul>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>到目前来说，pose estimation是一个还算比较热门的课题。目前看来工作相关热度不低，而且还有些能做的地方，比如说3d pose目前的工作就不是很多，2d多人估计的方法还需要进一步改善，目前最好的是sjtu提出的alphapose，不过该库沿用了自顶而下的设计，所以我觉得基于PAF这种连接特征的自底而上的方法还有探究空间。之后不太忙的时候可能把network代码拉出来分析分析再写一篇吧……</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/07/05/batch-hard/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="IcewineChen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/Rinne.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Icewine">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/05/batch-hard/" itemprop="url">batch_hard</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-07-05T10:10:32+08:00">
                2018-07-05
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/mxnet/" itemprop="url" rel="index">
                    <span itemprop="name">mxnet</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>I have reproduced a mxnet-version of batch_hard triplet loss.If you want to get the code, click this website(<a href="https://github.com/IcewineChen/mxnet-batch_hard_triplet_loss)" target="_blank" rel="noopener">https://github.com/IcewineChen/mxnet-batch_hard_triplet_loss)</a>. I achieve the batch hard in this repository.</p>
<h2 id="Based"><a href="#Based" class="headerlink" title="Based"></a>Based</h2><p>Based on <in defense="" of="" triplet="" loss=""> (<a href="https://arxiv.org/abs/1703.07737).If" target="_blank" rel="noopener">https://arxiv.org/abs/1703.07737).If</a> you want more details of batch hard triplet loss, read this paper please. It’s really a good work.</in></p>
<h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><ul>
<li>In this paper,authors propose a new format of triplet loss called batch hard</li>
<li>Efficient for re-id tasks</li>
<li>Inplement the hard mining method and soft-margin</li>
<li>Can be used in re-id tasks</li>
</ul>
<h2 id="Architecture"><a href="#Architecture" class="headerlink" title="Architecture"></a>Architecture</h2><ul>
<li>Used resnetV2 to get 128-dimensions embeddings</li>
<li>Used triplet loss to train embeddings</li>
</ul>
<h2 id="大概意思"><a href="#大概意思" class="headerlink" title="大概意思"></a>大概意思</h2><p>其实就是我用mxnet复现了一版batch hard triplet loss的代码。最早我是在re-id task相关的文章上看到了这篇方法，原文在arxiv上，17年出的……当时用了作者给的repo跑，实验了batch hard和batch all两种形式的triplet loss，发现效果相当不错，思路写得也相当清晰（具体文章请见上面给的链接哈=-=），不过paper reading太久之前做的了，可能之后再用到这种思路的时候会写一篇paper reading整理思路。不过其实为什么work，文章的思路已经写得很明白了，hard mining。batch-all的方法利用了全部可以使用的三元组，将样本中的三元组利用大幅提高，这种trick非常简单粗暴，但是确实在batch-hard前在market1501的benchmark上非常行之有效。但是batch hard的方法从另一个角度入手，对batch内的样本进行hard-mining，去学习极端的三元组。这个hard-mining的过程简单可以概括为选最难的，也就是对选取的anchor距离最远的正样本，同理再选最难的负样本组成一个三元组，这样就选择了最有效的三元组，收敛后效果一定是比原始的triplet loss效果要好的。这个思路非常的简单易懂，但是确实很work。为了快和方便调试我就做了一版mxnet版本的batch hard的代码。tensorflow版本调试的时候确实比较尴尬……相比之下同样采用符号式编程思想的mxnet调试相当简洁，动态图中间的值可以各种print和查看，而且dataloader也方便调试，继承以后主要就注意两点：一是shape二是变量名，内部的检查机制主要就这两件事，由于值在动态图计算过程中打断点到内部很简单，所以调试起来也非常爽快。如果对这版代码或是相关工作感兴趣，请戳我的github主页，链接戳这里：(<a href="https://github.com/IcewineChen/mxnet-batch_hard_triplet_loss" target="_blank" rel="noopener">https://github.com/IcewineChen/mxnet-batch_hard_triplet_loss</a>)</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/09/04/caffe-installation/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="IcewineChen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/Rinne.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Icewine">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/09/04/caffe-installation/" itemprop="url">caffe-installation</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-09-04T20:25:19+08:00">
                2017-09-04
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/deep-learning/" itemprop="url" rel="index">
                    <span itemprop="name">deep learning</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="关于安装"><a href="#关于安装" class="headerlink" title="关于安装"></a>关于安装</h3><p>本篇讲述的是关于A卡rmbp的caffe安装与编译中一些问题的解决。</p>
<h3 id="Caffe版本"><a href="#Caffe版本" class="headerlink" title="Caffe版本"></a>Caffe版本</h3><p>我download下的是目前最新的caffe1.0。<br>关于download caffe1.0的包，直接git clone下来</p>
<blockquote>
<p>git clone <a href="https://github.com/BVLC/caffe.git" target="_blank" rel="noopener">https://github.com/BVLC/caffe.git</a></p>
</blockquote>
<h3 id="配合食用的工具"><a href="#配合食用的工具" class="headerlink" title="配合食用的工具"></a>配合食用的工具</h3><p>brew基本都用。没有下载homebrew的盆友请如下操作安装homebrew及依赖项<br><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="keyword">bin/ruby </span>-e <span class="string">"$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"</span></span><br><span class="line"><span class="keyword">brew </span>install wget</span><br></pre></td></tr></table></figure></p>
<p>之后的caffe编译过程建议选择cmake，cmake使用在后面会说。我们会选用brew进行安装</p>
<h3 id="需要的环境"><a href="#需要的环境" class="headerlink" title="需要的环境"></a>需要的环境</h3><h4 id="1-python与c-环境准备"><a href="#1-python与c-环境准备" class="headerlink" title="1.python与c++环境准备"></a>1.python与c++环境准备</h4><p>首先是关于python的问题。之前本地上安装的2.7和3.6，但是在安装过程中改动Makefile的过程中始终会导致numpy连接到System下的pythonframework里。由于这个问题有两个解决方法，后面会详细说道。如果不想释放权限，可以选择安装anaconda，对于之后Makefile.config中的配置比较友好。如果想关掉Rootless对Python.framework中的文件进行编辑，选择进入恢复模式csrutil disabled即可。然而这种头很铁的行为我不推荐。之后会以anaconda配置python的方式便于进行caffe python接口的编译。<br>BAIR的install文档关于libstdc++ installation的部分没什么需要多说的，基本上都不会因为标准库困扰。</p>
<h4 id="2-关于anaconda"><a href="#2-关于anaconda" class="headerlink" title="2.关于anaconda"></a>2.关于anaconda</h4><p>不能翻的盆友可以直接去tsinghua找一份anaconda的安装包，为了更好的支持caffe1.0，建议选择python2.7版本进行下载。这给一份下载链接：</p>
<blockquote>
<p><a href="https://mirrors.tuna.tsinghua.edu.cn/anaconda/archive/Anaconda2-5.0.0-MacOSX-x86_64.pkg" target="_blank" rel="noopener">https://mirrors.tuna.tsinghua.edu.cn/anaconda/archive/Anaconda2-5.0.0-MacOSX-x86_64.pkg</a></p>
</blockquote>
<p>之后懒人包安装。对环境变量进行配置。视个人使用在~/.bashrc或~/.zshrc(宇宙第一fish fish~/.config/fish/config.fish去set)中添加</p>
<blockquote>
<p>export PATH=~/anaconda/bin:$PATH</p>
</blockquote>
<p>之后关于anaconda的使用问题直接直接-h即可，我们直接使用anaconda建立并激活python2.7环境<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">conda <span class="keyword">create</span> <span class="comment">--name python27 python=2.7</span></span><br><span class="line"><span class="keyword">activate</span> python27</span><br><span class="line"><span class="keyword">source</span> <span class="keyword">activate</span> python27</span><br></pre></td></tr></table></figure></p>
<p>其他包的管理可以选择pip或者conda install进行。</p>
<h4 id="3-其他依赖项安装"><a href="#3-其他依赖项安装" class="headerlink" title="3.其他依赖项安装"></a>3.其他依赖项安装</h4><p>根据BAIR的官方文档进行安装。<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">brew <span class="keyword">install</span> -vd snappy leveldb gflags glog szip lmdb</span><br><span class="line"># need the homebrew science <span class="keyword">source</span> <span class="keyword">for</span> OpenCV <span class="keyword">and</span> hdf5</span><br><span class="line">brew tap homebrew/science</span><br><span class="line">brew <span class="keyword">install</span> hdf5 opencv</span><br></pre></td></tr></table></figure></p>
<p>如果之前安装过snappy等库，卸了更新，写个脚本sh一下，依赖项也这部分可以参见官方文档<br><figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> snappy leveldb gflags glog szip hdf5 lmdb homebrew/science/opencv;</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    brew uninstall $x;</span><br><span class="line">    brew install --fresh -vd $x;</span><br><span class="line">done</span><br><span class="line">brew install --build-from-<span class="keyword">source</span> --with-<span class="keyword">python</span> -vd protobuf</span><br><span class="line">brew install --build-from-<span class="keyword">source</span> -vd boost boost-<span class="keyword">python</span></span><br></pre></td></tr></table></figure></p>
<h3 id="caffe编译安装"><a href="#caffe编译安装" class="headerlink" title="caffe编译安装"></a>caffe编译安装</h3><p>caffe down下来以后，开始caffe的安装和编译。进入的caffe根目录，以我本地为例如下：</p>
<p><img src="http://oy6b059ev.bkt.clouddn.com/caffe%E5%AE%89%E8%A3%851.png" alt=""></p>
<p>之后准备进行caffe的编译。在这里先要根据你的需要动一下Makefile.config。为了开启python接口和选择只用CPU模式，我们需要对原生makefile的一些部分进行修改<br>首先是CPU_ONLY。将line8的cpu_only=1 uncomment掉，改成只用CPU的模式</p>
<p><img src="http://oy6b059ev.bkt.clouddn.com/cpu_only1.png" alt=""></p>
<p>之后要进行python和matlab接口安装的配置。如果想要开启matlab接口，将下图的matlab部分uncomment掉并根据你的matlab路径进行设置。我开了python接口的配置。python接口给了你两个选择。没有安装anaconda的话你可以选择将你本地的python2.7路径和numpy/core作为python_include的值，但是每次这样做最后都会发现无法import numpy.core.multiarray，print出numpy路径后会发现这里没有链到lib/python而是链到了/System/Library/Framework中的Python.Frameworks中的numpy库，其中numpy的版本不符合caffe1.0的要求。因此要不改掉rootless，用更新的numpy替代。这里有链接关于此问题的解决：</p>
<blockquote>
<p><a href="https://stackoverflow.com/questions/20518632/importerror-numpy-core-multiarray-failed-to-import" target="_blank" rel="noopener">https://stackoverflow.com/questions/20518632/importerror-numpy-core-multiarray-failed-to-import</a></p>
</blockquote>
<p>如果不想这么改动，请启用anaconda进行python环境设置。之前有讲到anaconda的环境设置，之后需要在anaconda设置的环境中装好需要的库即可。此时python路径如下图中的anaconda几行配置完成</p>
<p><img src="http://oy6b059ev.bkt.clouddn.com/pylib.png" alt=""></p>
<p>原生的caffe本身不带build和cmake这些目录。我们进入到caffe根目录后，先建立一个build文件夹并在其下进行编译<br><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir build</span><br><span class="line"><span class="function"><span class="title">cmake</span></span> ..</span><br></pre></td></tr></table></figure></p>
<p>cmake过后会贴出一些信息，展示caffe的安装依赖项是否已经安装齐和版本是否满足要求，以及你需要安装的接口、以及模式的设置，请仔细阅读，如有缺失项请回到caffe根目录下make clean清除并重新按照上面的一些步骤与说明安装依赖项，并重复上述make过程。</p>
<p><img src="http://oy6b059ev.bkt.clouddn.com/cmake1.png" alt=""></p>
<p>之后需要对两个文件改动,一个是cmakecache.txt,另一个是caffeconfig.cmake。其中关于CPU_ONLY的设置还是off，所以需要改动。</p>
<p><img src="http://oy6b059ev.bkt.clouddn.com/buildcpu_only.png" alt=""><br><img src="http://oy6b059ev.bkt.clouddn.com/set.png" alt=""></p>
<p>看完配置信息，如果觉得没问题，继续make</p>
<blockquote>
<p>make all</p>
</blockquote>
<p><img src="http://oy6b059ev.bkt.clouddn.com/makeall.png" alt=""><br>make all之后会提示你pycaffe的信息，之后</p>
<blockquote>
<p>make pycaffe</p>
</blockquote>
<p><img src="http://oy6b059ev.bkt.clouddn.com/pycaffe.png" alt=""></p>
<p>okay，整个过程配置完毕，最后结果如下：</p>
<p><img src="http://oy6b059ev.bkt.clouddn.com/caffedone.png" alt=""></p>
<p>之后去examples跑一下caffe的例子就可以了。可以看一下转化lmdb等等数据格式的一些预备知识在进行食用。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  


          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/Rinne.png"
                alt="IcewineChen" />
            
              <p class="site-author-name" itemprop="name">IcewineChen</p>
              <p class="site-description motion-element" itemprop="description">for technology</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">9</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">5</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">9</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/IcewineChen" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:xidianchr@gmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">IcewineChen</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
